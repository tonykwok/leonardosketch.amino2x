<html>
<head>
<script src="../leonardosketch-amino2x/dist/amino.js" language="JavaScript"></script>
<script src="characters.js" language="JavaScript"></script>
<style type="text/css">
body, canvas { border: 0px solid black; padding: 0; margin: 0;}
</style>
</head>
<body>
<canvas id="canvas" width="1024" height="730"></canvas>

<script language="JavaScript">

function Player() {
    Circle.call(this);
    this.dxv = 0.0;
    this.dyv = 2.0;
    this.onGround = false;
}
Player.extend(Circle);

var runner = new Runner();
runner.setCanvas(document.getElementById("canvas"));

runner.setFPS(30);
runner.setBackground("white");

var pan = new Group();



//platforms
var platform_color = "rgb(170,250,210)";//new Color(170,250,210);
var platform_stroke_color = "rgb(0,255,100)";//new Color(0,255,100);


var winSpot = new Rect()
    .set(50,-1250,50,50);
winSpot.setFill("red");
winSpot.setStroke("rgb(200,0,0)");
winSpot.setStrokeWidth(3);
pan.add(winSpot);

// player
var player = new Player();
player.set(100, 400, 20);
player.setFill("#aaaaaa");
player.setStroke("#888888");
player.setStrokeWidth(3);

pan.add(player);
var ground = new Group()
pan.add(ground);


//backgrounds
var background0 = new Group(); //fixed
var background1 = new Group(); //half speed
var background2 = new Group(); //full speed


function cg(x,y,w,h) {
    return new Rect().set(x,y,w,h).setFill(platform_color).setStroke(platform_stroke_color).setStrokeWidth(3);
}
function cg2(x,y,w,h) {
    return new Rect().set(x,y,w,h).setFill("#003366").setStroke("#002244").setStrokeWidth(3);
}

function setupGrassLevel() {
    //bg
    background0.add(new Rect().set(0,0,1024,730).setFill("rgb(230,240,255)"));    
    //sun
    background0.add(new Circle().set(300,300,100).setFill("#FCD116"));
    
    //parallax hills
    background1.add(new Transform(hill).setTranslateX(-100).setTranslateY(200));
    background1.add(new Transform(hill).setTranslateX(280).setTranslateY(100));
    background1.add(new Transform(hill).setTranslateX(200).setTranslateY(200));
    ground.add(cg(-300,500,3400,600));
    ground.add(cg(300,400,1000,100));
    ground.add(cg(500,300,400,100));
    
    ground.add(cg(1800,400,400,100));
    background1.add(new Transform(hill).setTranslateX(1100).setTranslateY(150));
    background1.add(new Transform(hill).setTranslateX(1180).setTranslateY(100));
    background1.add(new Transform(hill).setTranslateX(1250).setTranslateY(120));
    background2.add(new Text().setText("use arrow keys to move and jump").setFill("black").setX(100).setY(200));
    
    ground.add(cg(3300,500,3400,600));
    player.setX(0).setY(200);
    winSpot.setX(3800).setY(450);
}

//sky level
function setupSkyLevel() {
    //set up the static background
    background0.add(new Rect().set(0,0,1024,730).setFill("rgb(230,240,255)"));
    background0.add(new Circle().set(200,200,100).setFill("orange"));
    var cloud = new Group()
        .add(new Circle().set(280, 300, 80).setFill("white"))
        .add(new Circle().set(360, 280, 100).setFill("white"))
        .add(new Circle().set(420, 300, 80).setFill("white"))
        ;
    background1.add(new Group().add(cloud).setX(100));
    background1.add(new Group().add(cloud).setX(800));
    background1.add(new Group().add(cloud).setX(600).setY(-400));
    background1.add(new Group().add(cloud).setX(1500).setY(-400));
    /*
    ghost.setX(-100);
    ghost.setY(-200);
    runner.addAnim(new PropAnim(ghost,"x",0,100,2).setLoop(true).setAutoReverse(true));
    */
//    background1.add(ghost);
    ground
        .add(cg(0,     500,  400, 100))
        .add(cg(500,   400,  400, 100))
        .add(cg(400,   200,  400, 100))
        .add(cg(1000,  300,  400, 100))
        .add(cg(1500,  200,  400, 100))
        .add(cg(1800,  100,  400, 100))
        .add(cg(2000,   0,   200, 100))
        .add(cg(2250, -100,  200, 100))
        .add(cg(2500, -200,  200, 100))
        .add(cg(2100, -300,  300, 100))
        .add(cg(1900, -400,  300, 100))
        .add(cg(1500, -500, 300, 100))
        .add(cg(1000, -500, 300, 100))
        .add(cg(400,  -500, 450, 100))
        .add(cg(0,   -600, 400, 300))
        ;
    background2.add(new Text().setText("skyward").setFill("black").setX(100).setY(200));
    winSpot.setX(50).setY(-650);
    player.setX(60).setY(100);
}


function setupSpaceLevel() {
    //bg
    background0.add(new Rect().set(0,0,1024,730).setFill("black"));    
    //sun
    background0.add(new Circle().set(150,200,50).setFill("#cccccc"));
    background2.add(new Text().setText("spaceward").setFill("white").setX(100).setY(200));
    background2.add(new Text().setText("just keep on going").setFill("white").setX(1400).setY(100));
    background2.add(new Text().setText("Sorry. I haven't built this part yet.").setFill("white").setX(1400).setY(1000));
    ground.add(cg2(-300,500,400,600));
    ground.add(cg2(0,400,400,600));
    ground.add(cg2(450,300,100,600));
    ground.add(cg2(650,300,100,600));
    ground.add(cg2(850,300,100,600));
    ground.add(cg2(1050,300,100,600));
    ground.add(cg2(1250,300,100,600));
    player.setX(-100).setY(200);
}

var levels = [];
levels[0] = setupGrassLevel;
levels[1] = setupSkyLevel;
levels[2] = setupSpaceLevel;

var levelNumber = 0;
levels[levelNumber]();


function nextLevel() {
    //do later
    overlay.setVisible(false);
    levelNumber++;
    background0.clear();
    background1.clear();
    background2.clear();
    ground.clear();
    levels[levelNumber]();
}

//camera 
var cameraBounds = new Rect().set(300,150,350,300);
cameraBounds.setFill("rgba(255,0,0,0.1)");

var overlay = new Text();
overlay.setText("foo");
overlay.setX(100);
overlay.setY(100);
overlay.setFont("60pt Arial");
overlay.setFill("black");
overlay.setVisible(false);


var buttons = new Group();
var leftButton = new Rect().set(0,0,100,50).setFill("rgba(255,0,0,0.1)");
leftButton.setCorner(15);
runner.listen("MOUSE_PRESS",leftButton,function() {   left = true; right=false; });
runner.listen("MOUSE_RELEASE",leftButton,function() { left = false; });
var rightButton = new Rect().set(110,0,100,50).setFill("rgba(255,0,0,0.1)");
rightButton.setCorner(15);
runner.listen("MOUSE_PRESS",rightButton,function() {   right = true; left=false; });
runner.listen("MOUSE_RELEASE",rightButton,function() { right = false; });
buttons.add(leftButton);
buttons.add(rightButton);
var jumpButton = new Rect().set(850,0,100,50).setFill("rgba(255,0,0,0.1)");
jumpButton.setCorner(15);
runner.listen("MOUSE_PRESS",jumpButton,function() {   up = true; });
runner.listen("MOUSE_RELEASE",jumpButton,function() { up = false; });
buttons.add(jumpButton);
buttons.setX(20).setY(580);


runner.setRoot(new Group()
    .add(background0)
    .add(background1)
    .add(background2)
    .add(pan)
    //.add(cameraBounds)
    .add(overlay)
    .add(buttons)
    );
runner.start();

runner.addCallback(update);

var VK_UP = 38;
var VK_LEFT = 37;
var VK_RIGHT = 39;
runner.listen("KEY_PRESSED",null, function(e) {
    if(e.key == VK_UP) up = true;
    if(e.key == VK_LEFT) left = true;
    if(e.key == VK_RIGHT) right = true;
});
runner.listen("KEY_RELEASED",null, function(e) {
    if(e.key == VK_UP) up = false;
    if(e.key == VK_LEFT) left = false;
    if(e.key == VK_RIGHT) right = false;
});


var gravity = 0.7;
var speed = 6;
var jump_impulse = -13;

var up = false;
var left = false;
var right = false;

function update() {
    player.dxv = 0;
    //go left and right
    if(left) {
        player.dxv = -speed;
    }
    if(right) {
        player.dxv =  speed;
    }
    var x = player.getX()+player.dxv;
    if(player.getX() != x) {
        player.setX(x);
    }
    
    var y = player.getY();

    
    //check if intersects with platforms
    
    var ret = intersectsGround(ground,player);
    if(ret.intersected) {
        y = ret.node.getY()-player.getRadius();
        player.dyv = 0;
        player.onGround = true;
    } else {
        player.dyv += gravity;
        y += player.dyv;
    }
    
    //jump
    if(player.onGround && up) {
        player.dyv = jump_impulse;
        player.onGround = false;
        y += player.dyv;
    }
    
    
    //check dead
    if(player.getY() > 2000) {
        player.setX(100);
        y = 100;
    }
    
    if(player.getY() != y) {
        player.setY(y);
    }

    //check for win
    if(intersectsRect(winSpot,player).intersected) {
        overlay.setText("Level "+levelNumber+" ... complete!");
        overlay.setVisible(true);
        
        //do later
        nextLevel();
    }
    
    
    //scroll the camera
    if(player.getX()+pan.getX() > cameraBounds.getX()+cameraBounds.getWidth()) {
        var dx = player.getX()+pan.getX()-(cameraBounds.getX()+cameraBounds.getWidth());
        setPanX(pan.getX() - dx);
    }
    if(player.getX()+pan.getX() < cameraBounds.getX()) {
        var dx = player.getX()+pan.getX()-cameraBounds.getX();
        setPanX(pan.getX() - dx);
    }
    if(player.getY()+pan.getY() < cameraBounds.getY()) {
        var dy = player.getY()+pan.getY()-cameraBounds.getY();
        setPanY(pan.getY()-dy);
    }
    if(player.getY()+pan.getY() > cameraBounds.getY()+cameraBounds.getHeight()) {
        var dy = player.getY()+pan.getY()-(cameraBounds.getY()+cameraBounds.getHeight());
        setPanY(pan.getY()-dy);
    }
}


function setPanY(v) {
    pan.setY(v);
    background1.setY(v/2);
    background2.setY(v);
}

function setPanX(v) {
    pan.setX(v);
    background1.setX(v/2);
    background2.setX(v);
}

function intersectsGround(ground, circle) {
    for(var i=0; i<ground.childCount(); i++) {
        var ground_part = ground.getChild(i);
        var ret = intersectsRect(ground_part,circle);
        if(ret.intersected) {
            return ret;
        }
    }
    return {intersected:false};
}

function intersectsRect(ground, circle) {
    var y = circle.getY()+circle.getRadius();
    var left = circle.getX()-circle.getRadius();
    var right = circle.getX()+circle.getRadius();
    //between top and bottom
    if(y >= ground.getY() && y <= ground.getY()+ground.getHeight()) {
        if(between(left,ground.getX(),ground.getX()+ground.getWidth())) {
            return { intersected: true, node: ground };
        }
        if(between(right,ground.getX(),ground.getX()+ground.getWidth())) {
            return { intersected: true, node: ground };
        }
        return { intersected: false };
    }
    return { intersected: false };
}

function between(v1,left, right) {
    if(v1 >= left && v1 <= right) return true;
    return false;
}

window.onunload = function() {
    console.log("unloading!");
    runner.stop();
    runner.cleanup();
};
</script>

</body>
</html>
